#!/bin/bash
# Submit text directly to Reeder
# Usage: submit-text <title> [text or - for stdin]

set -euo pipefail

# Resolve inbox path from config
get_inbox() {
    local config="${REEDER_CONFIG:-}"
    if [[ -z "$config" ]]; then
        # Search standard locations
        local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        for candidate in "$script_dir/../config.toml" "/etc/reeder/config.toml" "$HOME/.config/reeder/config.toml"; do
            if [[ -f "$candidate" ]]; then
                config="$candidate"
                break
            fi
        done
    fi
    
    if [[ -z "$config" ]] || [[ ! -f "$config" ]]; then
        echo "/var/lib/reeder/inbox"  # fallback
        return
    fi
    
    # Parse TOML with Python
    python3 -c "
import tomllib
from pathlib import Path
with open('$config', 'rb') as f:
    cfg = tomllib.load(f)
base = Path(cfg['paths']['base_dir'])
inbox = base / cfg['paths']['inbox']
print(inbox)
"
}

INBOX="${REEDER_INBOX:-$(get_inbox)}"
TITLE="${1:-Untitled}"
TEXT="${2:-}"

if [[ "$TEXT" == "-" ]] || [[ -z "$TEXT" ]]; then
    TEXT=$(cat)
fi

if [[ -z "$TEXT" ]]; then
    echo "Usage: $0 <title> <text>"
    echo "       $0 <title> -  # read from stdin"
    echo "       echo 'text' | $0 <title>"
    exit 1
fi

TIMESTAMP=$(date +%s)
SLUG=$(echo "$TITLE" | sed 's|[^a-zA-Z0-9]|-|g' | cut -c1-50)
FILENAME="${TIMESTAMP}-${SLUG}.json"

# Escape text for JSON
TEXT_ESCAPED=$(echo "$TEXT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

cat > "${INBOX}/${FILENAME}" <<EOF
{
  "type": "text",
  "title": "$TITLE",
  "text": $TEXT_ESCAPED
}
EOF

echo "Submitted: ${FILENAME}"
