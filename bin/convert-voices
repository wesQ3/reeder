#!/usr/bin/env python3
"""
Convert WAV voice files to safetensors format for faster loading.

Usage:
    ./bin/convert-voices [--truncate]

Converts all .wav files in voices/ to .safetensors format.
"""

import subprocess
import sys
from pathlib import Path


def main():
    script_dir = Path(__file__).parent
    voices_dir = script_dir.parent / "voices"
    
    if not voices_dir.exists():
        print(f"Error: {voices_dir} does not exist")
        sys.exit(1)
    
    # Find all WAV files
    wav_files = list(voices_dir.glob("*.wav"))
    
    if not wav_files:
        print(f"No .wav files found in {voices_dir}")
        return
    
    print(f"Found {len(wav_files)} WAV file(s) to convert:")
    for wav in wav_files:
        print(f"  - {wav.name}")
    print()
    
    # Check for --truncate flag
    truncate = "--truncate" in sys.argv
    
    # Convert each WAV to safetensors
    for wav_file in wav_files:
        safetensors_file = wav_file.with_suffix(".safetensors")
        
        if safetensors_file.exists():
            print(f"‚è≠Ô∏è  Skipping {wav_file.name} (already converted)")
            continue
        
        print(f"üîÑ Converting {wav_file.name}...")
        
        # Use GitHub version which has export-voice command
        cmd = [
            "uvx", "--from", "git+https://github.com/kyutai-labs/pocket-tts.git",
            "pocket-tts", "export-voice", str(wav_file), str(safetensors_file)
        ]
        if truncate:
            cmd.append("--truncate")
        
        try:
            subprocess.run(cmd, check=True, capture_output=True)
            print(f"‚úÖ Created {safetensors_file.name}")
        except subprocess.CalledProcessError as e:
            print(f"‚ùå Failed to convert {wav_file.name}: {e.stderr.decode()}")
            continue
    
    print()
    print("Done! Converted files:")
    for st in voices_dir.glob("*.safetensors"):
        size_mb = st.stat().st_size / (1024 * 1024)
        print(f"  - {st.name} ({size_mb:.2f} MB)")
    print()
    print("Update config.toml to use .safetensors files:")
    print('  default_voice = "default.safetensors"')


if __name__ == "__main__":
    main()
